<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implementation - Hirpdag</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="ch01-00-introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="ch02-00-hirpdag.html"><strong aria-hidden="true">2.</strong> Hirpdag</a></li><li class="chapter-item expanded "><a href="ch03-00-implementation.html" class="active"><strong aria-hidden="true">3.</strong> Implementation</a></li><li class="chapter-item expanded "><a href="ch04-00-techniques.html"><strong aria-hidden="true">4.</strong> Techniques</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Hirpdag</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="implementation"><a class="header" href="#implementation">Implementation</a></h1>
<h2 id="hashing"><a class="header" href="#hashing">Hashing</a></h2>
<p>Want stable hashing.
Do not hash on pointer values.</p>
<h2 id="hashconsing"><a class="header" href="#hashconsing">Hashconsing</a></h2>
<h3 id="weak-references"><a class="header" href="#weak-references">Weak references</a></h3>
<h4 id="intrusive-counters-with-weak-count"><a class="header" href="#intrusive-counters-with-weak-count">Intrusive counters with weak count</a></h4>
<p>Reference counts in same allocation as data. When strong ref count hits zero, destroy the data.
Until the weak ref count hits zero, the object remains to indicate that there is zero strong refs so weak refs cannot access data.</p>
<p>Consider adding indirection to the data if the data is large and weak pointers may survive a long time.</p>
<p>Good catch coherency, fewer allocations.</p>
<h4 id="separate-counters-with-weak-count"><a class="header" href="#separate-counters-with-weak-count">Separate counters with weak count</a></h4>
<p>Reference counts in a separate allocation to the data. When strong ref count hits zero the allocation for the data can be freed.
The allocation for the counts remains to indicate the pointer is now invalid until the weak ref count also hits zero.</p>
<p>Reference objects have two pointers, one to the counters and one to the object. Strong refs can access the data pointer directly.
Weak refs must access the counters first and check strong is nonzero to upgrade.</p>
<p>Less cache coherency, more allocations.</p>
<h4 id="weak-reference-with-intrusive-linked-list"><a class="header" href="#weak-reference-with-intrusive-linked-list">Weak reference with intrusive linked list</a></h4>
<p>All weak refs to an object form an intrusive linked list. The head of the linked list is stored with the reference counts.
As part of deleting an object, traverse all the weak references to that object via the intrusive linked list and set them to null.</p>
<h3 id="reference-counting-optimizations"><a class="header" href="#reference-counting-optimizations">Reference Counting Optimizations</a></h3>
<h4 id="cache-invalidation-and-immutability"><a class="header" href="#cache-invalidation-and-immutability">Cache Invalidation and Immutability</a></h4>
<p>Updating a reference count will <a href="https://dl.acm.org/doi/10.1145/185009.185016">modify a cache line</a> containing an object.
One of the strengths of immutable data, such as objects in Hirpdag, is that it can be shared between threads.
Modifying reference counts adjacent to objects will dirty unmodified shared cache lines.</p>
<p>Unmodified cache lines can remain in the <a href="https://en.m.wikipedia.org/wiki/MESI_protocol">Shared state</a></p>
<h4 id="coalescing-and-elision"><a class="header" href="#coalescing-and-elision">Coalescing and Elision</a></h4>
<p>Coalescing reference count modifications together can reduce update operations by <a href="https://dl.acm.org/doi/10.1145/2426642.2259008">50-90%</a>.
Only the first increment and last decrement need to remain in the same place.
This kind of statement reodering and combining would need compiler support to be
<a href="https://www.microsoft.com/en-us/research/uploads/prod/2020/11/perceus-tr-v1.pdf">applied comprehensively</a>.</p>
<h2 id="comparisons"><a class="header" href="#comparisons">Comparisons</a></h2>
<h3 id="pointer-equality"><a class="header" href="#pointer-equality">Pointer Equality</a></h3>
<p>Compare object pointers for equality or inequality.</p>
<h3 id="ordering"><a class="header" href="#ordering">Ordering</a></h3>
<p>Cannot use the object pointers for ordering in many contexts, they are unstable and meaningless.</p>
<p>A deterministic ordering is desirable, which reflects a partial order of the global Hirpdag object DAG.</p>
<h2 id="normalization"><a class="header" href="#normalization">Normalization</a></h2>
<p>On construction.</p>
<h2 id="rewriting"><a class="header" href="#rewriting">Rewriting</a></h2>
<p>Apply rewrite rule to self.
Rewrite all children.
Construct a replacement for self, if anything changed.</p>
<h2 id="memoization"><a class="header" href="#memoization">Memoization</a></h2>
<p>Enabled by immutability and reference counting.</p>
<p>Hash map of reference to reference. Key is input, value is output.</p>
<h2 id="serialization"><a class="header" href="#serialization">Serialization</a></h2>
<p>Leaf objects should appear before other objects which use them.
The serialization ordering should be a valid bottom up partial order.
A post-order traversal will produce one possible linear ordering.</p>
<p>Good to mark reference handle roots in serialization format.</p>
<h2 id="cache-coherent-datastructures"><a class="header" href="#cache-coherent-datastructures">Cache coherent datastructures</a></h2>
<p>Immutable data will typically make non-contiguous data structures (such as tree-sets, tree-maps, and linked-lists) less appealing.</p>
<p>Cache line size is typically 64 bytes on most modern x86 systems.</p>
<pre><code class="language-shell">$ getconf LEVEL1_DCACHE_LINESIZE
64
</code></pre>
<h2 id="object-metadata"><a class="header" href="#object-metadata">Object Metadata</a></h2>
<p>Each Hirpdag Object has a small amount of metadata attached to it. This includes:</p>
<ul>
<li>DAG Height</li>
<li>DAG Count</li>
<li>Content flags</li>
</ul>
<p>The content flags are intended to provide a hint to avoid unnecessary traversals.</p>
<h2 id="reference-count-update-elision"><a class="header" href="#reference-count-update-elision">Reference Count Update Elision</a></h2>
<p>Incrementing and decrementing can be expensive and they may occur frequently. Because the count is shared so these updates must be atomic.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="ch02-00-hirpdag.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="ch04-00-techniques.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="ch02-00-hirpdag.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="ch04-00-techniques.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
